---
modules:
  - docassemble.mentalkb.loader
  - docassemble.mentalkb.rules
  - docassemble.mentalkb.util
---
code: |
  kb = KB()
  page_sequence = []
  current_page = None
  page_history = []
---
mandatory: True
code: |
  if not page_sequence:
      page_sequence = kb.get_page_sequence(None)
      if not page_sequence:
          need('no_pages_available')
      current_page = page_sequence[0]

  def advance_to_next_page():
      global current_page, current_questions
      while current_page:
        current_questions = kb.questions_for(current_page.id)
        if current_questions:
            return
        page_history.append(current_page.name)
        next_page = resolve_next_page(kb, None, current_page, page_history)
        if next_page is None:
            need('wrap_up')
        current_page = next_page

  advance_to_next_page()
  the_fields = build_fields(kb, current_questions, user_dict())
  need('render_page')
---
id: render_page
question: ${ current_page.title or "MentalkB Interview" }
subquestion: |
  Please answer the following questions.
fields: ${ the_fields }
continue button field: proceed
---
code: |
  if defined('proceed'):
      page_history.append(current_page.name)
      next_page = resolve_next_page(kb, None, current_page, page_history)
      if next_page is None:
          del proceed
          need('wrap_up')
      current_page = next_page
      del proceed
      del the_fields
      del current_questions
      need('mandatory')
---
id: no_pages_available
event: done
question: No pages found
subquestion: |
  The MentalkB database returned no pages. Verify seed data.
buttons:
  - Restart: restart
---
id: wrap_up
event: save_results
code: |
  captured = {k: v for k, v in user_dict().items() if k.startswith('q_')}
  save_session_results(user_email if defined('user_email') else None, captured)
---
event: done
question: Interview complete
subquestion: |
  Your responses were saved to the MentalkB database.
attachment:
  - name: MentalkB Summary
    filename: mentalkb-summary.md
    content file: templates/summary.md
buttons:
  - Restart: restart
  - Finish: exit
